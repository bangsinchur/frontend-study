<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Interceptor Practice</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  </head>
  <body>
    <h1>Interceptor Practice</h1>

    <!-- Test buttons for auth status -->
    <button onclick="login()">Login</button>
    <button onclick="logout()">Logout</button>
    <button onclick="fetchData()">Fetch Data</button>

    <!-- Status display areas -->
    <div id="loading" style="display: none">Loading...</div>
    <div id="error" style="display: none; color: red"></div>
    <div id="result"></div>

    <script>
      // 상태 관리를 위한 유틸리티 함수들
      function showLoading() {
        document.getElementById("loading").style.display = "block";
      }

      function hideLoading() {
        document.getElementById("loading").style.display = "none";
      }

      function showError(message) {
        const errorDiv = document.getElementById("error");
        errorDiv.style.display = "block";
        errorDiv.textContent = message;
      }

      function hideError() {
        document.getElementById("error").style.display = "none";
      }

      function displayResult(message) {
        const resultDiv = document.getElementById("result");
        resultDiv.innerHTML += `<p>${message}</p>`;
      }

      // API 클라이언트 설정
      const apiClient = axios.create({
        baseURL: "https://jsonplaceholder.typicode.com",
        timeout: 5000,
      });

      // 토큰 관리 (실제로는 localStorage나 더 안전한 방법 사용)
      let authToken = null;

      apiClient.interceptors.request.use(
        function (config) {
          // 요청 보내기 전 수행할 작업
          showLoading();

          // 토큰이 있으면 헤더에 추가
          if (authToken) {
            config.headers.Authorization = `Bearer ${authToken}`;
          }

          return config;
        },
        function (error) {
          // 요청 에러 처리
          hideLoading();
          showError("Request failed: " + error.message);
          return Promise.reject(error);
        }
      );

      // 응답 인터셉터 설정
      apiClient.interceptors.response.use(
        function (response) {
          // 응답 데이터 처리
          hideLoading();
          hideError();
          return response;
        },
        function (error) {
          // 응답 에러 처리
          hideLoading();

          if (error.response) {
            // 서버가 응답을 반환한 경우
            switch (error.response.status) {
              case 401:
                showError("Authentication required. Please login.");
                authToken = null; // 토큰 제거
                break;
              case 403:
                showError(
                  "You do not have permission to access this resource."
                );
                break;
              case 404:
                showError("Requested resource not found.");
                break;
              default:
                showError("Server error: " + error.response.status);
            }
          } else if (error.request) {
            // 요청은 보냈지만 응답을 받지 못한 경우
            showError("No response received from server.");
          } else {
            // 요청 설정 중 에러 발생
            showError("Error setting up request: " + error.message);
          }

          return Promise.reject(error);
        }
      );
      // 로그인 함수 (실제로는 서버와 통신하여 토큰을 받아옴)
      async function login() {
        try {
          // 실제 환경에서는 서버로 로그인 요청을 보내고 토큰을 받아옴
          // 여기서는 테스트를 위해 가상의 토큰을 생성
          authToken = "test_token_" + Date.now();
          displayResult("Successfully logged in");
        } catch (error) {
          showError("Login failed: " + error.message);
        }
      }

      // 로그아웃 함수
      function logout() {
        authToken = null;
        displayResult("Successfully logged out");
      }

      // 데이터 가져오기 함수
      async function fetchData() {
        try {
          // 게시글 목록 가져오기
          const response = await apiClient.get("/posts");

          // 결과 화면에 표시
          displayResult(`Fetched ${response.data.length} posts:`);

          // 처음 5개의 게시글만 표시
          response.data.slice(0, 5).forEach((post) => {
            displayResult(`- ${post.title}`);
          });
        } catch (error) {
          // 에러는 인터셉터에서 처리되므로 여기서는 추가 처리 불필요
          console.log("Error handled by interceptor");
        }
      }

      // 권한이 필요한 데이터 가져오기 테스트
      async function fetchProtectedData() {
        try {
          // 401 에러를 발생시키기 위해 잘못된 경로로 요청
          const response = await apiClient.get("/protected-data");
          displayResult(response.data);
        } catch (error) {
          // 에러는 인터셉터에서 처리됨
          console.log("Error handled by interceptor");
        }
      }
    </script>
  </body>
</html>
